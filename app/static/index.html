<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pi5 Media Loader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body{padding:20px} .mono{font-family:ui-monospace,monospace} </style>
</head>
<body>
  <h3>Pi5 Media Loader</h3>

  <!-- Row 1: URL/magnet add -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Add by URL / Magnet</h5>
      <form id="f-url" class="row g-2">
        <div class="col-12">
          <input class="form-control" name="source" placeholder="magnet:... or https://..." required>
        </div>
        <div class="col-md-4">
          <select class="form-select" name="engine">
            <option value="aria2" selected>aria2</option>
            <option value="transmission">transmission</option>
          </select>
        </div>
        <div class="col-md-4">
          <select class="form-select" name="kind">
            <option value="movies" selected>Movie</option>
            <option value="tvshows">TV</option>
          </select>
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary w-100" type="submit">Add Link</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Row 2: .torrent upload -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Upload .torrent file</h5>
      <form id="f-torrent" class="row g-2" enctype="multipart/form-data">
        <div class="col-md-4">
          <input class="form-control" type="file" name="torrent" accept=".torrent" required>
        </div>
        <div class="col-md-4">
          <select class="form-select" name="engine">
            <option value="aria2" selected>aria2</option>
            <option value="transmission">transmission</option>
          </select>
        </div>
        <div class="col-md-4">
          <select class="form-select" name="kind">
            <option value="movies" selected>Movie</option>
            <option value="tvshows">TV</option>
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-secondary" type="submit">Add Torrent</button>
        </div>
      </form>
    </div>
  </div>

  <h5>Queue</h5>
  <div id="queue" class="vstack gap-3"></div>

<script>
const out = document.getElementById('out');

document.getElementById('f-url').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = Object.fromEntries(fd.entries());
  console.log(payload);
  const res = await fetch('/api/add', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json();
  alert(j.ok ? 'Queued!' : ('Failed: ' (j.error || '')));
});

document.getElementById('f-torrent').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/api/add-torrent-file', {
    method:'POST',
    body: fd
  });
  const j = await res.json();
  alert(j.ok ? 'Queued (torrent file)!' : ('Failed: ' (j.error || '')));
});

const ws = new WebSocket(`ws://${location.host}/ws`);
const queueDiv = document.getElementById('queue');
function fmtSpeed(bps){
  const u=['B/s','KB/s','MB/s','GB/s','TB/s'];
  let i=0,v=Number(bps)||0;
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return (i===0? v.toFixed(0): v.toFixed(2))+' '+u[i];
}

function fmtDT(ts){
  if(!ts) return '';
  const d = new Date(ts);
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
}

ws.onmessage = (ev)=>{
  const data = JSON.parse(ev.data);
  data.sort((a,b) => b.id - a.id);

  queueDiv.innerHTML = data.map(item=>{
    const pct = Math.max(0, Math.min(100, Number(item.progress)||0));
    const speed = fmtSpeed(item.speed_bps);
    const badgeCls = item.status==='completed' ? 'bg-success' :
                     item.status==='seeding'   ? 'bg-info'    :
                     'bg-secondary';

    const name = item.name || '(name pending)';
    const dt = fmtDT(item.created_at);

    return `
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">#${item.id} · ${item.engine} · ${item.kind}</div>
            <span class="badge ${badgeCls}">${item.status}</span>
          </div>
          <div class="small text-muted">${name}</div>                
          <div class="small text-muted">${dt}</div>                  
          <div class="small text-muted">${speed} (${item.status})</div> 
          <div class="progress" style="height:18px;">
            <div class="progress-bar" role="progressbar" style="width:${pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100">
              ${pct}%
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
};
</script>
</body>
</html>


